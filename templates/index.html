<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KSS">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/kss.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/kss_512.png">
    <link rel="apple-touch-icon" href="/static/kss_512.png">
    <title>KSS Judging System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            overscroll-behavior: none;
            touch-action: pan-x pan-y;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            padding: 12px;
            color: #e2e8f0;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea, button {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #f8fafc;
            margin-bottom: 16px;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .header-section {
            background: #1e293b;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .metadata-collapsed {
            padding: 0;
            background: transparent;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            color: #cbd5e1;
            margin-bottom: 12px;
            display: none;
            font-weight: 500;
        }
        
        .metadata-collapsed.active {
            display: block;
        }
        
        .metadata-form.hidden {
            display: none;
        }
        
        .metadata-field {
            display: flex;
            flex-direction: column;
        }
        
        .metadata-field label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #94a3b8;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .metadata-field input,
        .metadata-field textarea {
            padding: 10px 14px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            background: #0f172a;
            color: #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .metadata-field input:focus,
        .metadata-field textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: #1e293b;
        }
        
        .metadata-field textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .notes-field {
            grid-column: 1 / -1;
        }
        
        .surfer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .surfer-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .surfer-field label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .surfer-field input {
            padding: 8px 12px;
            border: 1px solid #334155;
            border-radius: 6px;
            font-size: 13px;
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .surfer-field input:focus {
            outline: none;
            border-color: #3b82f6;
            background: #1e293b;
        }
        
        .surfer-field input[type="number"] {
            font-weight: 600;
        }
        
        .timer-controls-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            letter-spacing: -0.02em;
            text-align: center;
        }
        
        .timer-display.warning {
            color: #fbbf24;
        }
        
        .timer-display.critical {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        
        .inline-controls {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .notes-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .notes-modal.active {
            display: flex;
        }
        
        .notes-modal-content {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            border: 1px solid #334155;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .notes-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .notes-modal-header h3 {
            margin: 0;
            color: #f1f5f9;
            font-size: 18px;
        }
        
        .notes-close-btn {
            background: #64748b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .notes-close-btn:hover {
            background: #475569;
        }
        
        .notes-modal textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        
        .notes-modal textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn-notes {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-notes:hover {
            background: #7c3aed;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-start { background: #10b981; color: white; }
        .btn-start:hover { background: #059669; }
        
        .btn-close { background: #ef4444; color: white; }
        .btn-close:hover { background: #dc2626; }
        
        .btn-reopen { background: #f59e0b; color: white; }
        .btn-reopen:hover { background: #d97706; }
        
        .btn-reset { background: #64748b; color: white; }
        .btn-reset:hover { background: #475569; }
        
        .btn-export { background: #8b5cf6; color: white; }
        .btn-export:hover { background: #7c3aed; }
        
        .priority-bar-container {
            background: #1e293b;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #334155;
        }
        
        .priority-bar-container h3 {
            color: #cbd5e1;
            margin-bottom: 14px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .priority-bar {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            align-items: stretch;
            min-height: 100px;
        }
        
        .priority-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 16px 12px;
            border-radius: 10px;
            background: #334155;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 80px;
            border: 2px solid transparent;
        }
        
        .priority-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: #64748b;
        }
        
        .priority-item:nth-child(1) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.5);
        }
        
        .priority-item:nth-child(2) {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }
        
        .priority-item.tied {
            background: #475569;
            color: #cbd5e1;
        }
        
        .priority-number {
            font-size: 28px;
            margin-bottom: 6px;
            font-weight: 700;
        }
        
        .priority-color {
            font-size: 15px;
            letter-spacing: 0.02em;
        }
        
        .priority-label {
            font-size: 10px;
            opacity: 0.9;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 64% 34%;
            gap: 12px;
            align-items: start;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 0;
            max-width: 100%;
        }
        
        .grid-container {
            background: #1e293b;
            border-radius: 10px;
            padding: 14px;
            border: 1px solid #334155;
            overflow-x: auto;
            max-width: 100%;
        }
        
        table {
            width: 100%;
            min-width: 900px;
            border-collapse: separate;
            border-spacing: 4px;
        }
        
        th {
            background: #334155;
            color: #cbd5e1;
            padding: 8px;
            font-weight: 600;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        td {
            padding: 6px;
            text-align: center;
        }
        
        .color-cell {
            font-weight: 700;
            font-size: 14px;
            padding: 14px;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }
        
        .color-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
        }
        
        .interference-btn {
            position: absolute;
            bottom: 3px;
            right: 3px;
            padding: 3px 7px;
            background: #475569;
            color: #cbd5e1;
            border: none;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.05em;
        }
        
        .interference-btn:hover {
            background: #64748b;
        }
        
        .interference-btn.level-1 {
            background: #f59e0b;
            color: white;
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
        }
        
        .interference-btn.level-2 {
            background: #ef4444;
            color: white;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }
        
        .color-red { background: #991b1b; color: #fecaca; border: 1px solid #7f1d1d; }
        .color-yellow { background: #854d0e; color: #fef08a; border: 1px solid #713f12; }
        .color-black { background: #0f172a; color: #e2e8f0; border: 1px solid #1e293b; }
        .color-white { background: #f9fafb; color: #0f172a; border: 1px solid #e5e7eb; }
        .color-blue { background: #1e3a8a; color: #bfdbfe; border: 1px solid #1e40af; }
        
        input[type="number"] {
            width: 58px;
            padding: 9px 5px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            border: 1px solid #334155;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: #0f172a;
            color: #e2e8f0;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            background: #1e293b;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        input[type="number"].best-score {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: #d97706;
            color: #78350f;
            font-weight: 700;
        }
        
        .live-rankings {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }
        
        .live-rankings h3 {
            color: #cbd5e1;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .ranking-item:hover {
            transform: translateX(4px);
        }
        
        .ranking-item:nth-child(1) { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4);
            border-color: #d97706;
        }
        .ranking-item:nth-child(2) { 
            background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
            color: #0f172a;
            box-shadow: 0 4px 16px rgba(148, 163, 184, 0.3);
            border-color: #64748b;
        }
        .ranking-item:nth-child(3) { 
            background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
            color: #78350f;
            box-shadow: 0 4px 16px rgba(217, 119, 6, 0.3);
            border-color: #b45309;
        }
        .ranking-item:nth-child(n+4) { 
            background: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }
        
        .ranking-position {
            font-size: 22px;
            margin-right: 10px;
        }
        
        .ranking-waves {
            font-size: 11px;
            color: inherit;
            opacity: 0.8;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .score-needed {
            font-size: 14px;
            color: #0f172a;
            margin-top: 3px;
            font-weight: 700;
            font-style: italic;
        }
        
        .interference-indicator {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            margin-left: 6px;
            font-weight: 600;
        }
        
        .results {
            margin-top: 24px;
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .results h2 {
            color: #f8fafc;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }
        
        .export-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .performance-tracker {
            margin-top: 24px;
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
        }
        
        .performance-tracker h2 {
            color: #f8fafc;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 700;
        }
        
        .tracker-container {
            overflow-x: auto;
        }
        
        .tracker-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tracker-table th {
            background: #334155;
            color: #cbd5e1;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
            border-bottom: 2px solid #1e293b;
        }
        
        .tracker-table th:first-child {
            text-align: left;
        }
        
        .tracker-table td {
            padding: 12px 16px;
            text-align: center;
            border-bottom: 1px solid #1e293b;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .tracker-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .tracker-table tbody tr:hover {
            background: #1e293b;
        }
        
        .tracker-score {
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .tracker-goal {
            font-weight: 700;
            color: #fbbf24;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-hit {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .status-above {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
        }
        
        .status-below {
            background: #475569;
            color: #cbd5e1;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            
            input[type="number"] {
                width: 48px;
                padding: 7px 3px;
                font-size: 13px;
            }
            
            th {
                padding: 7px;
                font-size: 10px;
            }
            
            .btn {
                padding: 10px 18px;
                font-size: 13px;
            }
            
            .timer-display {
                font-size: 40px;
            }
            
            .priority-bar {
                gap: 6px;
            }
            
            .priority-item {
                min-height: 70px;
                padding: 10px 6px;
            }
            
            .priority-number {
                font-size: 22px;
            }
            
            .priority-color {
                font-size: 13px;
            }
            
            .priority-label {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- KSS Header -->
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <img src="/static/kss.png" alt="KSS" style="width: 48px; height: 48px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            <div>
                <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #f1f5f9; line-height: 1;">KSS</h1>
                <p style="margin: 2px 0 0 0; font-size: 13px; color: #94a3b8; font-weight: 500;">Karibe Surf Score</p>
            </div>
            <div style="flex: 1; text-align: center;">
                <span style="font-size: 14px; font-weight: 600; color: #f1f5f9; text-transform: uppercase; letter-spacing: 0.1em;">Coach Mode</span>
            </div>
        </div>
        
        <!-- Header Section -->
        <div class="header-section">
            <!-- Collapsed metadata view (shown after heat starts) -->
            <div id="metadataCollapsed" class="metadata-collapsed"></div>
            
            <!-- Full metadata form (shown before heat starts) -->
            <div id="metadataForm" class="metadata-form">
                <div class="metadata-grid">
                    <div class="metadata-field">
                        <label>Heat Number</label>
                        <input type="text" id="heat_number" value="{{ metadata.heat_number }}" onchange="updateMetadata()">
                    </div>
                    <div class="metadata-field">
                        <label>Category</label>
                        <input type="text" id="category" value="{{ metadata.category }}" onchange="updateMetadata()" placeholder="Open Men, U18, etc.">
                    </div>
                    <div class="metadata-field">
                        <label>Round</label>
                        <input type="text" id="round" value="{{ metadata.round }}" onchange="updateMetadata()">
                </div>
                <div class="metadata-field">
                    <label>Location</label>
                    <input type="text" id="location" value="{{ metadata.location }}" onchange="updateMetadata()">
                </div>
                <div class="metadata-field">
                    <label>Duration (min)</label>
                    <input type="number" id="duration" value="{{ metadata.duration }}" min="1" max="60" onchange="updateMetadata()">
                </div>
                </div>
                
                <!-- Surfer Names and Goals -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
                    <h3 style="color: #cbd5e1; font-size: 14px; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">üë• Surfers & Goals</h3>
                    <div class="surfer-grid">
                        <div class="surfer-field">
                            <label style="color: #fecaca;">üî¥ Red Surfer</label>
                            <input type="text" id="red_name" placeholder="Name" onchange="updateSurferData()">
                            <input type="number" id="red_goal" placeholder="Goal" step="0.1" min="0" max="20" onchange="updateSurferData()">
                        </div>
                        <div class="surfer-field">
                            <label style="color: #fef08a;">üü° Yellow Surfer</label>
                            <input type="text" id="yellow_name" placeholder="Name" onchange="updateSurferData()">
                            <input type="number" id="yellow_goal" placeholder="Goal" step="0.1" min="0" max="20" onchange="updateSurferData()">
                        </div>
                        <div class="surfer-field">
                            <label style="color: #e2e8f0;">‚ö´ Black Surfer</label>
                            <input type="text" id="black_name" placeholder="Name" onchange="updateSurferData()">
                            <input type="number" id="black_goal" placeholder="Goal" step="0.1" min="0" max="20" onchange="updateSurferData()">
                        </div>
                        <div class="surfer-field">
                            <label style="color: #0f172a; background: #f9fafb; padding: 2px 8px; border-radius: 4px;">‚ö™ White Surfer</label>
                            <input type="text" id="white_name" placeholder="Name" onchange="updateSurferData()">
                            <input type="number" id="white_goal" placeholder="Goal" step="0.1" min="0" max="20" onchange="updateSurferData()">
                        </div>
                        <div class="surfer-field">
                            <label style="color: #bfdbfe;">üîµ Blue Surfer</label>
                            <input type="text" id="blue_name" placeholder="Name" onchange="updateSurferData()">
                            <input type="number" id="blue_goal" placeholder="Goal" step="0.1" min="0" max="20" onchange="updateSurferData()">
                        </div>
                    </div>
                </div>
                
                <div class="metadata-field notes-field" style="display: none;">
                    <textarea id="notes" onchange="updateMetadata()">{{ metadata.notes }}</textarea>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Timer and Controls Row (Full Width) -->
        <div class="timer-controls-row">
            <button class="btn btn-start" onclick="startTimer()" id="startBtn">‚ñ∂Ô∏è Start</button>
            <div class="timer-display" id="timerDisplay">{{ metadata.duration }}:00</div>
            <div class="inline-controls">
                <button class="btn btn-notes" onclick="openNotesModal()">üìù Notes</button>
                <button class="btn btn-close" onclick="closeHeat()" id="closeBtn">üèÅ Close</button>
                <button class="btn btn-reopen" onclick="reopenHeat()" id="reopenBtn" style="display:none;">üîì Reopen</button>
                <button class="btn btn-reset" onclick="resetHeat()">üîÑ Reset</button>
            </div>
        </div>
        
        <!-- Main Content: Grid+Priority (left) and Rankings (right) -->
        <div class="main-grid">
            <!-- Left Column: Grid + Priority -->
            <div class="left-column">
                <!-- Score Grid -->
                <div class="grid-container">
                    <table>
                    <thead>
                        <tr>
                            <th>Surfer</th>
                            <th>W1</th>
                            <th>W2</th>
                            <th>W3</th>
                            <th>W4</th>
                            <th>W5</th>
                            <th>W6</th>
                            <th>W7</th>
                            <th>W8</th>
                            <th>W9</th>
                            <th>W10</th>
                            <th>W11</th>
                            <th>W12</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for idx, surfer in surfers %}
                        <tr>
                            <td class="color-cell color-{{ surfer.color|lower }}" onclick="sendToBackOfQueue({{ idx }})" title="Click to send to back of priority queue">
                                {{ surfer.color }}
                                <button class="interference-btn {% if surfer.interference == 1 %}level-1{% elif surfer.interference == 2 %}level-2{% endif %}" 
                                        onclick="event.stopPropagation(); toggleInterference({{ idx }})" 
                                        id="interference-{{ idx }}"
                                        title="Click: None ‚Üí INT-1 (¬Ω 2nd wave) ‚Üí INT-2 (¬Ω both waves) ‚Üí None">INT</button>
                            </td>
                            {% for wave_idx in range(12) %}
                            <td>
                                <input 
                                    type="number" 
                                    min="0" 
                                    max="10" 
                                    step="0.1"
                                    data-surfer="{{ idx }}"
                                    data-wave="{{ wave_idx }}"
                                    id="score-{{ idx }}-{{ wave_idx }}"
                                    value="{{ surfer.waves[wave_idx] if surfer.waves[wave_idx] is not none else '' }}"
                                    onchange="updateScore(this)"
                                >
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Priority Bar (below grid, same column) -->
            <div class="priority-bar-container">
                <h3>üéØ Priority Order (Click to send right ‚û°Ô∏è)</h3>
                <div id="priorityOrder" class="priority-bar"></div>
            </div>
            </div>
            
            <!-- Right Column: Live Rankings -->
            <div class="live-rankings">
                <h3>üìä Live Rankings</h3>
                <div id="liveRankings"></div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results" id="results">
            <h2>üèÜ Final Results</h2>
            <div class="export-buttons">
                <a href="/export_csv" class="btn btn-export" download>üìä Export CSV</a>
                <a href="/export_pdf" class="btn btn-export" download>üìÑ Export PDF</a>
            </div>
            <div id="results-content"></div>
        </div>
        
        <!-- Performance Tracker Section -->
        <div class="performance-tracker" id="performanceTracker" style="display: none;">
            <h2>üìà Session Performance Tracker</h2>
            <div class="export-buttons" style="margin-bottom: 16px;">
                <a href="/export_session_csv" class="btn btn-export" download>üìä Export Session CSV</a>
            </div>
            <div class="tracker-container">
                <table class="tracker-table" id="trackerTable">
                    <thead>
                        <tr>
                            <th>Surfer</th>
                            <th>Heat 1</th>
                            <th>Heat 2</th>
                            <th>Heat 3</th>
                            <th>Heat 4</th>
                            <th>Heat 5</th>
                            <th>Heat 6</th>
                            <th>Average</th>
                            <th>Goal</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="trackerBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Notes Modal -->
        <div id="notesModal" class="notes-modal" onclick="closeNotesModal(event)">
            <div class="notes-modal-content" onclick="event.stopPropagation()">
                <div class="notes-modal-header">
                    <h3>üìù Heat Notes</h3>
                    <button class="notes-close-btn" onclick="closeNotesModal()">‚úï Close</button>
                </div>
                <textarea id="notesTextarea" placeholder="Add observations, incidents, key moments..."></textarea>
            </div>
        </div>
    </div>
    
    <script>
        let timerInterval = null;
        let startTime = null;
        let duration = {{ metadata.duration }};
        let heatStarted = false;
        
        function openNotesModal() {
            // Sync textarea with hidden notes field
            document.getElementById('notesTextarea').value = document.getElementById('notes').value;
            document.getElementById('notesModal').classList.add('active');
        }
        
        function closeNotesModal(event) {
            // Only close if clicking on modal background or close button
            if (!event || event.target === document.getElementById('notesModal')) {
                // Save notes back to hidden field
                document.getElementById('notes').value = document.getElementById('notesTextarea').value;
                updateMetadata();
                document.getElementById('notesModal').classList.remove('active');
            }
        }
        
        function updateMetadata() {
            const metadata = {
                heat_number: document.getElementById('heat_number').value,
                category: document.getElementById('category').value,
                round: document.getElementById('round').value,
                location: document.getElementById('location').value,
                duration: parseInt(document.getElementById('duration').value),
                notes: document.getElementById('notes').value
            };
            
            duration = metadata.duration;
            document.getElementById('timerDisplay').textContent = `${duration}:00`;
            
            fetch('/update_metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(metadata)
            });
            
            updateCollapsedView();
        }
        
        function updateSurferData() {
            const surferData = {
                red: {
                    name: document.getElementById('red_name').value,
                    goal: parseFloat(document.getElementById('red_goal').value) || 0
                },
                yellow: {
                    name: document.getElementById('yellow_name').value,
                    goal: parseFloat(document.getElementById('yellow_goal').value) || 0
                },
                black: {
                    name: document.getElementById('black_name').value,
                    goal: parseFloat(document.getElementById('black_goal').value) || 0
                },
                white: {
                    name: document.getElementById('white_name').value,
                    goal: parseFloat(document.getElementById('white_goal').value) || 0
                },
                blue: {
                    name: document.getElementById('blue_name').value,
                    goal: parseFloat(document.getElementById('blue_goal').value) || 0
                }
            };
            
            fetch('/update_surfers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(surferData)
            });
        }
        
        function updateCollapsedView() {
            const heatNum = document.getElementById('heat_number').value || 'N/A';
            const category = document.getElementById('category').value || 'N/A';
            const round = document.getElementById('round').value || 'N/A';
            const location = document.getElementById('location').value || 'N/A';
            const dur = document.getElementById('duration').value || '20';
            
            const collapsedText = `Heat ${heatNum} ‚Ä¢ ${category} ‚Ä¢ ${round} ‚Ä¢ ${location} ‚Ä¢ ${dur} min`;
            document.getElementById('metadataCollapsed').textContent = collapsedText;
        }
        
        function collapseMetadata() {
            document.getElementById('metadataForm').classList.add('hidden');
            document.getElementById('metadataCollapsed').classList.add('active');
            heatStarted = true;
        }
        
        function expandMetadata() {
            document.getElementById('metadataForm').classList.remove('hidden');
            document.getElementById('metadataCollapsed').classList.remove('active');
            heatStarted = false;
        }
        
        function startTimer() {
            if (timerInterval) return;
            
            // Collapse metadata when starting timer
            collapseMetadata();
            
            fetch('/start_timer', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // Use timestamp in milliseconds to avoid timezone issues
                    startTime = Date.now();
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('startBtn').style.opacity = '0.5';
                    
                    timerInterval = setInterval(updateTimerDisplay, 100);
                });
        }
        
        function updateTimerDisplay() {
            const now = Date.now();
            const elapsed = Math.floor((now - startTime) / 1000);
            const totalSeconds = duration * 60;
            const remaining = Math.max(0, totalSeconds - elapsed);
            
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            
            const display = document.getElementById('timerDisplay');
            display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (remaining <= 60) {
                display.className = 'timer-display critical';
            } else if (remaining <= 300) {
                display.className = 'timer-display warning';
            } else {
                display.className = 'timer-display';
            }
            
            if (remaining === 0) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateScore(input) {
            const surferIdx = input.dataset.surfer;
            const waveIdx = input.dataset.wave;
            const score = input.value;
            
            fetch('/update_score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    surfer_idx: parseInt(surferIdx),
                    wave_idx: parseInt(waveIdx),
                    score: score
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    input.value = '';
                } else {
                    updateLiveRankings(data.rankings);
                    highlightBestScores(data.rankings);
                }
            });
        }
        
        function sendToBackOfQueue(surferIdx) {
            fetch('/toggle_priority', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ surfer_idx: surferIdx })
            })
            .then(response => response.json())
            .then(data => {
                updatePriorityDisplay(data.priority_order);
            });
        }
        
        function updatePriorityDisplay(priorityOrder) {
            const container = document.getElementById('priorityOrder');
            let html = '';
            
            priorityOrder.forEach((item, index) => {
                const isTied = item.position === 'TIED';
                const isFirst = !isTied && item.position === 1;
                
                const emoji = isTied ? '=' : (isFirst ? 'üëë' : item.position);
                const label = isTied ? 'TIED' : (isFirst ? 'HAS PRIORITY' : '');
                const tiedClass = isTied ? 'tied' : '';
                
                html += `
                    <div class="priority-item ${tiedClass}" onclick="sendToBackOfQueue(${item.idx})" title="Click to send right">
                        <div class="priority-number">${emoji}</div>
                        <div class="priority-color">${item.color}</div>
                        ${label ? `<div class="priority-label">${label}</div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleInterference(surferIdx) {
            fetch('/toggle_interference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ surfer_idx: surferIdx })
            })
            .then(response => response.json())
            .then(data => {
                const btn = document.getElementById(`interference-${surferIdx}`);
                btn.className = 'interference-btn';
                
                if (data.interference === 1) {
                    btn.classList.add('level-1');
                } else if (data.interference === 2) {
                    btn.classList.add('level-2');
                }
                
                updateLiveRankings(data.rankings);
                highlightBestScores(data.rankings);
            });
        }
        
        function highlightBestScores(rankings) {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.classList.remove('best-score');
            });
            
            rankings.forEach(result => {
                const surferIdx = result.idx;
                const topScores = result.top_waves;
                
                const waves = [];
                for (let i = 0; i < 12; i++) {
                    const input = document.getElementById(`score-${surferIdx}-${i}`);
                    if (input.value) {
                        waves.push({ idx: i, score: parseFloat(input.value) });
                    }
                }
                
                waves.sort((a, b) => b.score - a.score);
                const topTwo = waves.slice(0, 2);
                
                topTwo.forEach(wave => {
                    const input = document.getElementById(`score-${surferIdx}-${wave.idx}`);
                    input.classList.add('best-score');
                });
            });
        }
        
        function updateLiveRankings(rankings) {
            const container = document.getElementById('liveRankings');
            let html = '';
            
            // Get totals for 1st and 2nd place for calculations
            const firstPlaceTotal = rankings.length > 0 ? rankings[0].total : 0;
            const secondPlaceTotal = rankings.length > 1 ? rankings[1].total : 0;
            
            rankings.forEach((result, index) => {
                const emoji = result.position === 1 ? 'ü•á' : 
                             result.position === 2 ? 'ü•à' : 
                             result.position === 3 ? 'ü•â' : 
                             `${result.position}.`;
                
                const wavesStr = result.top_waves.map(w => w.toFixed(1)).join(' + ');
                
                let interferenceStr = '';
                if (result.interference === 1) {
                    interferenceStr = '<span class="interference-indicator">INT-2</span>';
                } else if (result.interference === 2) {
                    interferenceStr = '<span class="interference-indicator">INT-1</span>';
                }
                
                // Calculate score needed
                let scoreNeeded = '';
                if (result.position === 2) {
                    // 2nd place needs to beat 1st
                    const targetTotal = firstPlaceTotal + 0.01;
                    const bestWave = result.top_waves.length > 0 ? result.top_waves[0] : 0;
                    const waveNeeded = targetTotal - bestWave;
                    
                    if (waveNeeded <= 10.0) {
                        scoreNeeded = `<div class="score-needed">needs ${waveNeeded.toFixed(2)} for 1st</div>`;
                    } else {
                        scoreNeeded = `<div class="score-needed">needs combo - ${targetTotal.toFixed(2)} for 1st</div>`;
                    }
                } else if (result.position >= 3) {
                    // 3rd-5th need to beat 2nd
                    const targetTotal = secondPlaceTotal + 0.01;
                    const bestWave = result.top_waves.length > 0 ? result.top_waves[0] : 0;
                    const waveNeeded = targetTotal - bestWave;
                    
                    if (waveNeeded <= 10.0) {
                        scoreNeeded = `<div class="score-needed">needs ${waveNeeded.toFixed(2)} for 2nd</div>`;
                    } else {
                        scoreNeeded = `<div class="score-needed">needs combo - ${targetTotal.toFixed(2)} for 2nd</div>`;
                    }
                }
                
                html += `
                    <div class="ranking-item">
                        <div>
                            <span class="ranking-position">${emoji}</span>
                            <strong>${result.color}</strong>${interferenceStr}
                            <div class="ranking-waves">${wavesStr || 'No scores'}</div>
                            ${scoreNeeded}
                        </div>
                        <div style="font-size: 20px;">${result.total.toFixed(2)}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function closeHeat() {
            fetch('/close_heat', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    displayResults(data.results);
                    updatePerformanceTracker();
                    document.getElementById('closeBtn').style.display = 'none';
                    document.getElementById('reopenBtn').style.display = 'inline-block';
                    
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                });
        }
        
        function reopenHeat() {
            fetch('/reopen_heat', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('results').classList.remove('show');
                    document.getElementById('closeBtn').style.display = 'inline-block';
                    document.getElementById('reopenBtn').style.display = 'none';
                });
        }
        
        function updatePerformanceTracker() {
            fetch('/get_session_tracker')
                .then(response => response.json())
                .then(data => {
                    const trackerBody = document.getElementById('trackerBody');
                    const tracker = data.tracker;
                    
                    if (Object.keys(tracker).length === 0) {
                        return; // No data yet
                    }
                    
                    let html = '';
                    
                    for (const [name, info] of Object.entries(tracker)) {
                        const heats = info.heats || [];
                        const goal = info.goal || 0;
                        const validHeats = heats.filter(h => h !== null);
                        const bestScore = validHeats.length > 0 ? Math.max(...validHeats) : 0;
                        const avgScore = validHeats.length > 0 ? validHeats.reduce((a, b) => a + b, 0) / validHeats.length : 0;
                        
                        let statusBadge = '';
                        if (bestScore >= goal && goal > 0) {
                            if (bestScore > goal) {
                                statusBadge = '<span class="status-badge status-above">üî• Above Goal</span>';
                            } else {
                                statusBadge = '<span class="status-badge status-hit">‚úÖ Goal Hit!</span>';
                            }
                        } else if (goal > 0) {
                            statusBadge = '<span class="status-badge status-below">‚è≥ In Progress</span>';
                        }
                        
                        html += '<tr>';
                        html += `<td>${name}</td>`;
                        
                        // Show up to 6 heats
                        for (let i = 0; i < 6; i++) {
                            if (i < heats.length && heats[i] !== null) {
                                html += `<td class="tracker-score">${heats[i].toFixed(2)}</td>`;
                            } else {
                                html += '<td style="color: #475569;">-</td>';
                            }
                        }
                        
                        html += `<td class="tracker-score" style="font-weight: 700; color: #60a5fa;">${avgScore > 0 ? avgScore.toFixed(2) : '-'}</td>`;
                        html += `<td class="tracker-goal">${goal > 0 ? goal.toFixed(1) : '-'}</td>`;
                        html += `<td>${statusBadge}</td>`;
                        html += '</tr>';
                    }
                    
                    trackerBody.innerHTML = html;
                    document.getElementById('performanceTracker').style.display = 'block';
                });
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            let html = '';
            results.forEach(result => {
                const emoji = result.position === 1 ? 'ü•á' : 
                             result.position === 2 ? 'ü•à' : 
                             result.position === 3 ? 'ü•â' : 
                             `${result.position}.`;
                
                const wavesStr = result.top_waves.map(w => w.toFixed(1)).join(' + ');
                
                let interferenceStr = '';
                if (result.interference === 1) {
                    interferenceStr = ' <span class="interference-indicator">INT-1 (-¬Ω 2nd wave)</span>';
                } else if (result.interference === 2) {
                    interferenceStr = ' <span class="interference-indicator">INT-2 (-¬Ω both waves)</span>';
                }
                
                html += `
                    <div class="ranking-item">
                        <div>
                            <span class="ranking-position">${emoji}</span>
                            <strong>${result.color}</strong>${interferenceStr}
                            <div class="ranking-waves">${wavesStr}</div>
                        </div>
                        <div style="font-size: 24px;">${result.total.toFixed(2)}</div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            resultsDiv.classList.add('show');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetHeat() {
            if (confirm('Are you sure you want to reset all scores and timer?')) {
                fetch('/reset_heat', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        document.querySelectorAll('input[type="number"]').forEach(input => {
                            input.value = '';
                            input.classList.remove('best-score');
                        });
                        
                        document.querySelectorAll('.interference-btn').forEach(el => {
                            el.className = 'interference-btn';
                        });
                        
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }
                        startTime = null;
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').style.opacity = '1';
                        document.getElementById('timerDisplay').textContent = `${duration}:00`;
                        document.getElementById('timerDisplay').className = 'timer-display';
                        
                        document.getElementById('results').classList.remove('show');
                        document.getElementById('closeBtn').style.display = 'inline-block';
                        document.getElementById('reopenBtn').style.display = 'none';
                        
                        document.getElementById('liveRankings').innerHTML = '';
                        document.getElementById('notes').value = '';
                        
                        // Expand metadata form again for next heat
                        expandMetadata();
                        
                        fetch('/get_priority_order')
                            .then(response => response.json())
                            .then(data => updatePriorityDisplay(data.priority_order));
                    });
            }
        }
        
        // Load initial live rankings and priority order
        fetch('/get_rankings')
            .then(response => response.json())
            .then(data => {
                updateLiveRankings(data.rankings);
                highlightBestScores(data.rankings);
            });
        
        fetch('/get_priority_order')
            .then(response => response.json())
            .then(data => updatePriorityDisplay(data.priority_order));
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
